<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Who’s on the Range</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#f5f7fb; padding:20px; color:#111;}
  .wrap{max-width:720px;margin:0 auto;}
  h1,h2{font-size:20px;margin:0 0 8px;}
  .card{background:#fff;padding:14px;border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.06); margin-bottom:14px;}
  .row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f0f0f0;}
  .row:last-child{border-bottom:0;}
  .muted{color:#666;font-size:13px;}
  .empty{padding:20px;text-align:center;color:#666;}
  .btn{display:inline-block;background:#1f6feb;color:#fff;padding:6px 12px;border-radius:8px;border:0;font-weight:600;cursor:pointer;margin-top:8px;}
</style>
</head>
<body>
<div class="wrap">
  <h1>Who’s on the Range</h1>
  <p class="muted">Auto-refreshing list (last 8 hours). Entries persist for leaderboard purposes.</p>
  
  <div class="card" id="list"><div class="empty">Loading…</div></div>

  <h2>Leaderboard</h2>
  <div class="card" id="leaderboard"><div class="empty">Loading…</div></div>
</div>

<script>
const RAW_JSON_URL = 'https://sheetdb.io/api/v1/8yuxyngjvtksx';
const REFRESH_MS = 10000;
const EXPIRY_MS = 8 * 60 * 60 * 1000;

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function isoToDurationText(iso){ const diff=Math.floor((Date.now()-new Date(iso).getTime())/1000); return diff<60?'Just now':diff<3600?Math.floor(diff/60)+' min':Math.floor(diff/3600)+' hr '+Math.floor((diff%3600)/60)+' min'; }

let allEntries = [];

async function fetchAndRender(){
  const listEl = document.getElementById('list');
  const leaderboardEl = document.getElementById('leaderboard');
  try {
    const res = await fetch(RAW_JSON_URL + '?sort[timestamp]=desc');
    if (!res.ok) throw new Error('Fetch error '+res.status);
    allEntries = await res.json();

    const now = Date.now();

    // Build latest type per visitorId
    const latestByVisitor = {};
    allEntries.forEach(item=>{
      const ts=new Date(item.timestamp).getTime();
      const vid=item.visitorId;
      if(!vid) return;
      if(!latestByVisitor[vid] || ts>latestByVisitor[vid].timestamp){
        latestByVisitor[vid]={type:item.type||'checkin',timestamp:ts,name:item.name};
      }
    });

    // Only include checkins within 8 hours
    const recent = Object.values(latestByVisitor).filter(item=>item.type==='checkin' && now-item.timestamp<=EXPIRY_MS);

    // Render live list
    listEl.innerHTML = recent.length ? recent.map(item=>`<div class="row"><div><strong>${escapeHtml(item.name||'Unknown')}</strong></div><div class="muted">${isoToDurationText(item.timestamp)}</div></div>`).join('') : '<div class="empty">No one is currently checked in.</div>';

    // Leaderboard (all check-ins)
    const counts = {};
    allEntries.forEach(item=>{ if(item.type!=='checkout'){ const name=item.name||'Unknown'; counts[name]=(counts[name]||0)+1; } });
    const boardHtml = Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(([name,count])=>`<div class="row"><div><strong>${escapeHtml(name)}</strong></div><div class="muted">${count} check-ins</div></div>`).join('');
    leaderboardEl.innerHTML = boardHtml || '<div class="empty">No check-ins yet.</div>';

  } catch(err){
    console.error(err);
    listEl.innerHTML=`<div class="empty">Error loading data: ${escapeHtml(err.message||err)}</div>`;
    leaderboardEl.innerHTML=`<div class="empty">Error loading data</div>`;
  }
}

fetchAndRender();
setInterval(fetchAndRender, REFRESH_MS);
</script>
</body>
</html>
