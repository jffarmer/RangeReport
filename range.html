<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Range Check-In & Dashboard</title>
<style>
:root { --accent:#1f6feb; --bg:#f7fbff; --card:#fff; color-scheme:light; }
body { font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); margin:0; padding:18px; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
.card { background:var(--card); border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.08); padding:18px; max-width:520px; width:100%; text-align:center; margin-bottom:14px; }
h1,h2{margin:6px 0 8px;}
p, .muted{margin:4px 0;color:#666;font-size:13px;}
input[type="text"]{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #ddd;box-sizing:border-box;font-size:16px;}
.btn{display:inline-block;background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:0;font-weight:600;cursor:pointer;margin-top:10px;}
.row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f0f0f0;}
.row:last-child{border-bottom:0;}
.empty{text-align:center;color:#666;padding:14px;}
</style>
</head>
<body>

<div class="card" id="checkinCard">
  <h1>üéØ Range Check-In</h1>

  <div id="setup" style="display:none;">
    <label class="small">What should we call you?</label>
    <input id="nameInput" placeholder="Your name" autocomplete="name" />
    <button class="btn" id="saveNameBtn">Save & Check In</button>
  </div>

  <div id="busy" style="display:none;">
    <div class="status" id="busyText">Checking you in‚Ä¶</div>
  </div>

  <div id="done" style="display:none;">
    <div class="status" id="doneText">You are checked in</div>
    <button class="btn" id="checkoutBtn">Check Out</button>
  </div>

  <div id="checkedOut" style="display:none;">
    <div class="status" id="checkedOutText">You are checked out</div>
    <button class="btn" id="checkBackInBtn">Check Back In</button>
  </div>

  <div id="error" style="display:none;">
    <div class="status" id="errorText">Error</div>
    <p class="muted" id="errorSub"></p>
    <button class="btn" id="retryBtn">Retry</button>
  </div>
</div>

<div class="card">
  <h2>üë• Who‚Äôs on the Range</h2>
  <div id="list"><div class="empty">Loading‚Ä¶</div></div>
</div>

<div class="card">
  <h2>üèÜ Leaderboard</h2>
  <div id="leaderboard"><div class="empty">Loading‚Ä¶</div></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const SUPABASE_URL = "https://ldrmmrsjmsnfguzfggkm.supabase.co";
const SUPABASE_KEY = "sb_publishable_LNrWXskGMEq9Bt0LSEy1rw_5EykATx_";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// DOM elements that *actually exist*
const nameInput = document.getElementById("nameInput");
const saveNameBtn = document.getElementById("saveNameBtn");
const checkoutBtn = document.getElementById("checkoutBtn");
const checkBackInBtn = document.getElementById("checkBackInBtn");
const listDiv = document.getElementById("list");
const leaderboardDiv = document.getElementById("leaderboard");

const setup = document.getElementById("setup");
const busy = document.getElementById("busy");
const done = document.getElementById("done");
const checkedOut = document.getElementById("checkedOut");
const errorDiv = document.getElementById("error");

let visitorId = localStorage.getItem("visitorId");

// ---------- UI STATE ----------
function showSetup() {
    setup.style.display = "block";
    busy.style.display = "none";
    done.style.display = "none";
    checkedOut.style.display = "none";
}

function showBusy(msg="Working‚Ä¶") {
    setup.style.display = "none";
    busy.style.display = "block";
    busyText.innerText = msg;
    done.style.display = "none";
    checkedOut.style.display = "none";
}

function showCheckedIn() {
    setup.style.display = "none";
    busy.style.display = "none";
    done.style.display = "block";
    checkedOut.style.display = "none";
}

function showCheckedOut() {
    setup.style.display = "none";
    busy.style.display = "none";
    done.style.display = "none";
    checkedOut.style.display = "block";
}
  
// Helper: friendly relative time
function timeAgo(ts) {
    const diff = Math.floor((Date.now() - new Date(ts).getTime()) / 1000);
    if (diff < 60) return 'Just now';
    if (diff < 3600) return `${Math.floor(diff / 60)} min ago`;
    return `${Math.floor(diff / 3600)} hr ${Math.floor((diff % 3600) / 60)} min ago`;
}

// Safe HTML escape
function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
}

// ---------- LOAD CURRENT STATE ----------
async function loadState() {
    if (!visitorId) {
        showSetup();
        return;
    }

    const { data, error } = await supabase
        .from("range_checkins")
        .select("*")
        .eq("visitorId", visitorId)
        .order("timestamp", { ascending: false })
        .limit(1);

    if (error || !data.length) {
        showSetup();
        return;
    }

    const last = data[0];
    if (last.type === "checkin") showCheckedIn();
    else showCheckedOut();
}

// ---------- CHECK IN ----------
saveNameBtn.addEventListener("click", async () => {
    const name = nameInput.value.trim();
    if (!name) return;

    showBusy("Checking you in‚Ä¶");

    visitorId = crypto.randomUUID();
    localStorage.setItem("visitorId", visitorId);

    const { error } = await supabase
        .from("range_checkins")
        .insert({
            name,
            visitorId,
            device: navigator.userAgent,
            timestamp: new Date().toISOString(),
            type: "checkin"
        });

    if (error) {
        console.error(error);
        showSetup();
        return;
    }

    nameInput.value = "";
    showCheckedIn();
    loadLists();
});

// ---------- CHECK OUT ----------
checkoutBtn.addEventListener("click", async () => {
    if (!visitorId) return;

    const { error } = await supabase
        .from("range_checkins")
        .insert({
            name,
            visitorId,
            device: navigator.userAgent,
            timestamp: new Date().toISOString(),
            type: "checkout"
        });

    if (error) {
        console.error(error);
        return;
    }

    showCheckedOut();
    loadLists();
});

// ---------- CHECK BACK IN ----------
checkBackInBtn.addEventListener("click", async () => {
    const name = prompt("Name?");
    if (!name) return;

    const { error } = await supabase
        .from("range_checkins")
        .insert({
            name,
            visitorId,
            device: navigator.userAgent,
            timestamp: new Date().toISOString(),
            type: "checkin"
        });

    if (error) {
        console.error(error);
        return;
    }

    showCheckedIn();
    loadLists();
});

// ---------- LOAD LISTS ----------
// ------------------ DASHBOARD RENDER ------------------
function loadLists() {
    const now = Date.now();

    // Aggregate latest entry per visitor
    const latestByVisitor = new Map();
    allEntries.forEach(item => {
        const vid = item.visitorId;
        if (!vid) return;
        const ts = new Date(item.timestamp).getTime();
        if (!latestByVisitor.has(vid) || ts > latestByVisitor.get(vid).timestamp) {
            latestByVisitor.set(vid, { ...item, timestamp: ts });
        }
    });

    // ----- Who's on the Range -----
    listDiv.innerHTML = "";
    const activeRows = [...latestByVisitor.values()].filter(r => r.type === "checkin");
    if (activeRows.length === 0) {
        listDiv.innerHTML = '<div class="empty">No one is currently on the range.</div>';
    } else {
        activeRows.forEach(row => {
            const div = document.createElement("div");
            div.className = "row";
            div.innerHTML = `
                <div><strong>${escapeHtml(row.name)}</strong></div>
                <div class="muted">Checked in: ${timeAgo(row.timestamp)}</div>
            `;
            listDiv.appendChild(div);
        });
    }

    // ----- Leaderboard -----
    leaderboardDiv.innerHTML = "";
    const counts = {};
    allEntries.forEach(item => {
        if (item.type === "checkin") {
            const name = item.name || "Unknown";
            counts[name] = (counts[name] || 0) + 1;
        }
    });

    const sortedLeaderboard = Object.entries(counts).sort((a, b) => b[1] - a[1]);

    if (sortedLeaderboard.length === 0) {
        leaderboardDiv.innerHTML = '<div class="empty">No check-ins yet.</div>';
    } else {
        sortedLeaderboard.forEach(([name, count]) => {
            const div = document.createElement("div");
            div.className = "row";
            div.innerHTML = `
                <div><strong>${escapeHtml(name)}</strong></div>
                <div class="muted">${count} check-in${count > 1 ? 's' : ''}</div>
            `;
            leaderboardDiv.appendChild(div);
        });
    }
}

// Realtime: reload lists on any change
supabase
  .channel("changes")
  .on("postgres_changes", { event:"*", schema:"public", table:"range_checkins" },
      payload => loadLists()
  )
  .subscribe();

// Initial load
loadState();
loadLists();
</script>



</body>
</html>
