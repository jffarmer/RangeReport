<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Range Check-In & Dashboard</title>
<style>
:root { --accent:#1f6feb; --bg:#f7fbff; --card:#fff; color-scheme:light; }
body { font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); margin:0; padding:18px; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
.card { background:var(--card); border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.08); padding:18px; max-width:520px; width:100%; text-align:center; margin-bottom:14px; }
h1,h2{margin:6px 0 8px;}
p, .muted{margin:4px 0;color:#666;font-size:13px;}
input[type="text"]{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #ddd;box-sizing:border-box;font-size:16px;}
.btn{display:inline-block;background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:0;font-weight:600;cursor:pointer;margin-top:10px;}
.row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f0f0f0;}
.row:last-child{border-bottom:0;}
.empty{text-align:center;color:#666;padding:14px;}
</style>
</head>
<body>

<div class="card" id="checkinCard">
  <h1>Range Check-In</h1>

  <div id="setup" style="display:none;">
    <label class="small">What should we call you?</label>
    <input id="nameInput" placeholder="Your name" autocomplete="name" />
    <button class="btn" id="saveNameBtn">Save & Check In</button>
  </div>

  <div id="busy" style="display:none;">
    <div class="status" id="busyText">Checking you in…</div>
  </div>

  <div id="done" style="display:none;">
    <div class="status" id="doneText">You are checked in</div>
    <button class="btn" id="checkoutBtn">Check Out</button>
  </div>

  <div id="checkedOut" style="display:none;">
    <div class="status" id="checkedOutText">You are checked out</div>
    <button class="btn" id="checkBackInBtn">Check Back In</button>
  </div>

  <div id="error" style="display:none;">
    <div class="status" id="errorText">Error</div>
    <p class="muted" id="errorSub"></p>
    <button class="btn" id="retryBtn">Retry</button>
  </div>
</div>

<div class="card">
  <h2>Who’s on the Range</h2>
  <div id="list"><div class="empty">Loading…</div></div>
</div>

<div class="card">
  <h2>Leaderboard</h2>
  <div id="leaderboard"><div class="empty">Loading…</div></div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const SUPABASE_URL = "https://ldrmmrsjmsnfguzfggkm.supabase.co";
const SUPABASE_KEY = "YOUR_PUBLIC_ANON_KEY";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// DOM elements
const checkinForm = document.getElementById("checkin-form");
const checkinNameInput = document.getElementById("checkin-name");
const checkinBtn = document.getElementById("checkin-btn");
const checkoutBtn = document.getElementById("checkout-btn");
const changeNameBtn = document.getElementById("change-name-btn");
const rangeList = document.getElementById("range-list");

let currentVisitorId = localStorage.getItem("visitor_id") || null;

// Load initial data
loadCheckins();

// -------- FETCH CHECKINS --------
async function loadCheckins() {
    const { data, error } = await supabase
        .from("range_checkins")
        .select("*")
        .is("checkout", null); // only show active

    if (error) {
        console.error(error);
        return;
    }

    renderActiveUsers(data);
}

// -------- RENDER ACTIVE USERS --------
function renderActiveUsers(list) {
    rangeList.innerHTML = "";

    list.forEach(entry => {
        const div = document.createElement("div");
        div.className = "user-entry";
        div.innerHTML = `
            <strong>${entry.name}</strong><br>
            Checked in: ${new Date(entry.checkin + "Z").toLocaleString()}
        `;
        rangeList.appendChild(div);
    });
}

// -------- CHECK IN --------
checkinBtn.addEventListener("click", async () => {
    const name = checkinNameInput.value.trim();
    if (!name) return;

    const { data, error } = await supabase
        .from("range_checkins")
        .insert({
            name,
            checkin: new Date().toISOString(),
            checkout: null
        })
        .select()
        .single();

    if (error) {
        console.error(error);
        return;
    }

    currentVisitorId = data.id;
    localStorage.setItem("visitor_id", currentVisitorId);

    checkinNameInput.value = "";
});

// -------- CHECK OUT --------
checkoutBtn.addEventListener("click", async () => {
    if (!currentVisitorId) return;

    const { error } = await supabase
        .from("range_checkins")
        .update({ checkout: new Date().toISOString() })
        .eq("id", currentVisitorId);

    if (error) console.error(error);

    localStorage.removeItem("visitor_id");
    currentVisitorId = null;
});

// -------- CHANGE NAME --------
changeNameBtn.addEventListener("click", async () => {
    if (!currentVisitorId) return;

    const newName = prompt("Enter your new name:");
    if (!newName) return;

    const { error } = await supabase
        .from("range_checkins")
        .update({ name: newName })
        .eq("id", currentVisitorId);

    if (error) console.error(error);
});

// -------- REALTIME UPDATES --------
supabase
    .channel("checkins-listener")
    .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "range_checkins" },
        payload => {
            loadCheckins(); // instant update
        }
    )
    .subscribe();

</script>


</body>
</html>
