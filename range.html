<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Range Check-In & Dashboard</title>
<style>
:root { --accent:#1f6feb; --bg:#f7fbff; --card:#fff; color-scheme:light; }
body { font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); margin:0; padding:18px; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
.card { background:var(--card); border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.08); padding:18px; max-width:520px; width:100%; text-align:center; margin-bottom:14px; }
h1,h2{margin:6px 0 8px;}
p, .muted{margin:4px 0;color:#666;font-size:13px;}
input[type="text"]{width:100%;padding:10px 12px;border-radius:8px;border:1px solid #ddd;box-sizing:border-box;font-size:16px;}
.btn{display:inline-block;background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:0;font-weight:600;cursor:pointer;margin-top:10px;}
.row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f0f0f0;}
.row:last-child{border-bottom:0;}
.empty{text-align:center;color:#666;padding:14px;}
</style>
</head>
<body>

<div class="card" id="checkinCard">
  <h1>Range Check-In</h1>

  <div id="setup" style="display:none;">
    <label class="small">What should we call you?</label>
    <input id="nameInput" placeholder="Your name" autocomplete="name" />
    <button class="btn" id="saveNameBtn">Save & Check In</button>
  </div>

  <div id="busy" style="display:none;">
    <div class="status" id="busyText">Checking you in…</div>
  </div>

  <div id="done" style="display:none;">
    <div class="status" id="doneText">You are checked in</div>
    <button class="btn" id="checkoutBtn">Check Out</button>
  </div>

  <div id="checkedOut" style="display:none;">
    <div class="status" id="checkedOutText">You are checked out</div>
    <button class="btn" id="checkBackInBtn">Check Back In</button>
  </div>

  <div id="error" style="display:none;">
    <div class="status" id="errorText">Error</div>
    <p class="muted" id="errorSub"></p>
    <button class="btn" id="retryBtn">Retry</button>
  </div>
</div>

<div class="card">
  <h2>Who’s on the Range</h2>
  <div id="list"><div class="empty">Loading…</div></div>
</div>

<div class="card">
  <h2>Leaderboard</h2>
  <div id="leaderboard"><div class="empty">Loading…</div></div>
</div>

<script>
const CHECKIN_ENDPOINT = 'https://sheetdb.io/api/v1/8yuxyngjvtksx';
const LS_KEY = 'range_identity_v1';
const REFRESH_MS = 10000;
const EXPIRY_MS = 8*60*60*1000;

const setupEl = document.getElementById('setup');
const busyEl = document.getElementById('busy');
const doneEl = document.getElementById('done');
const checkedOutEl = document.getElementById('checkedOut');
const errorEl = document.getElementById('error');
const nameInput = document.getElementById('nameInput');
const saveBtn = document.getElementById('saveNameBtn');
const retryBtn = document.getElementById('retryBtn');
const checkoutBtn = document.getElementById('checkoutBtn');
const checkBackInBtn = document.getElementById('checkBackInBtn');
const busyText = document.getElementById('busyText');
const errorSub = document.getElementById('errorSub');
const doneText = document.getElementById('doneText');
const checkedOutText = document.getElementById('checkedOutText');

function show(el){ setupEl.style.display='none'; busyEl.style.display='none'; doneEl.style.display='none'; checkedOutEl.style.display='none'; errorEl.style.display='none'; el.style.display='block'; }

function detectDevice(){
  const ua=navigator.userAgent||'';
  if(/iphone|ipad|ipod/i.test(ua))return 'iPhone';
  if(/android/i.test(ua))return 'Android';
  if(/macintosh|mac os x/i.test(ua))return 'Mac';
  if(/windows/i.test(ua))return 'Windows';
  return 'Device';
}

function getVisitorId(){
  const key='range_visitor_id_v1';
  let id=localStorage.getItem(key);
  if(!id){ id='u'+Math.random().toString(36).slice(2,9); localStorage.setItem(key,id);}
  return id;
}

async function postToSheet(data){
  return fetch(CHECKIN_ENDPOINT,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({data})
  });
}

// ------------------ STATE-AWARE FUNCTIONS ------------------
let allEntries = [];

async function fetchAllEntries(){
  try{
    const res = await fetch(CHECKIN_ENDPOINT+'?_='+Date.now());
    if(!res.ok) throw new Error('Fetch error '+res.status);
    allEntries = await res.json();
  }catch(err){ console.error(err); }
}

// Apply auto-checkouts for entries older than 8 hours
async function applyAutoCheckouts() {
  const now = Date.now();
  const latestByVisitor = {};

  allEntries.forEach(item => {
    const vid = item.visitorId;
    if (!vid) return;
    const ts = new Date(item.timestamp).getTime();
    if (!latestByVisitor[vid] || ts > latestByVisitor[vid].timestamp) {
      latestByVisitor[vid] = { ...item, timestamp: ts };
    }
  });

  for (const user of Object.values(latestByVisitor)) {
    if (user.type==='checkin' && now - user.timestamp > EXPIRY_MS) {
      try {
        await postToSheet({visitorId: user.visitorId, name: user.name, device: 'auto-expiry', timestamp: new Date().toISOString(), type: 'checkout'
        });
        console.log('Auto-checked out', user.name);
      } catch(err) { console.error('Failed to auto-checkout', user.name, err);}
    }
  }
}

function getMyLatestEntry(){
  const vid = getVisitorId();
  const myEntries = allEntries.filter(e=>e.visitorId===vid);
  if(!myEntries.length) return null;
  myEntries.sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp));
  return myEntries[0];
}

async function updateUIState(){
  await fetchAllEntries();
  await applyAutoCheckouts();
  await fetchAllEntries(); // refetch to include auto-checkouts
  const idObj = JSON.parse(localStorage.getItem(LS_KEY)||'null');
  if(!idObj){ show(setupEl); return; }

  const myLatest = getMyLatestEntry();
  const now = Date.now();
  if(!myLatest || myLatest.type==='checkout'){ 
    checkedOutText.textContent = `You are checked out`; 
    show(checkedOutEl);
  } else {
    const ts = new Date(myLatest.timestamp).getTime();
    if(now-ts>EXPIRY_MS){
      checkedOutText.textContent = `You are checked out (auto-expired)`; 
      show(checkedOutEl);
    } else {
      doneText.textContent = `Checked in as ${idObj.name}`;
      show(doneEl);
    }
  }
}

// ------------------ CHECK-IN / CHECK-OUT ------------------
async function doCheckin(){
  const idObj = JSON.parse(localStorage.getItem(LS_KEY)||'null');
  if(!idObj) return;
  show(busyEl); busyText.textContent='Checking you in…';
  try{
    await postToSheet({name:idObj.name, visitorId:getVisitorId(), device:detectDevice(), timestamp:new Date().toISOString(), type:'checkin'});
    await updateUIState();
  }catch(err){ console.error(err); errorSub.textContent=err.message||String(err); show(errorEl);}
}

async function doCheckout(){
  const myLatest = getMyLatestEntry();
  if(!myLatest) return;
  try{
    await postToSheet({visitorId: getVisitorId(), name: myLatest.name, device: detectDevice(), timestamp: new Date().toISOString(), type: 'checkout'});
    await updateUIState();
  }catch(err){ console.error(err); alert('Error checking out: '+(err.message||err)); }
}

// ------------------ EVENT LISTENERS ------------------
saveBtn.addEventListener('click',()=>{
  const val=nameInput.value && nameInput.value.trim();
  if(!val){ nameInput.focus(); return; }
  localStorage.setItem(LS_KEY, JSON.stringify({name:val}));
  doCheckin();
});
retryBtn.addEventListener('click', updateUIState);
checkoutBtn.addEventListener('click', doCheckout);
checkBackInBtn.addEventListener('click', doCheckin);

window.addEventListener('load', updateUIState);

// ------------------ LIVE LIST & LEADERBOARD ------------------
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function isoToDurationText(iso){ const diff=Math.floor((Date.now()-new Date(iso).getTime())/1000); return diff<60?'Just now':diff<3600?Math.floor(diff/60)+' min':Math.floor(diff/3600)+' hr '+Math.floor((diff%3600)/60)+' min';}

async function renderDashboard(){
  await fetchAllEntries();
  await applyAutoCheckouts();
  await fetchAllEntries();

  const now = Date.now();
  const latestByVisitor={};
  allEntries.forEach(item=>{
    const ts=new Date(item.timestamp).getTime(); const vid=item.visitorId;
    if(!vid) return;
    if(!latestByVisitor[vid] || ts>latestByVisitor[vid].timestamp) latestByVisitor[vid]={type:item.type||'checkin',timestamp:ts,name:item.name};
  });

  const recent=Object.values(latestByVisitor).filter(item=>item.type==='checkin'&&now-item.timestamp<=EXPIRY_MS);
  const listEl=document.getElementById('list');
  listEl.innerHTML = recent.length?recent.map(item=>`<div class="row"><div><strong>${escapeHtml(item.name||'Unknown')}</strong></div><div class="muted">${isoToDurationText(item.timestamp)}</div></div>`).join(''):'<div class="empty">No one is currently checked in.</div>';

  const counts={};
  allEntries.forEach(item=>{ if(item.type!=='checkout'){ const name=item.name||'Unknown'; counts[name]=(counts[name]||0)+1;} });
  const leaderboardEl=document.getElementById('leaderboard');
  const boardHtml=Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(([name,count])=>`<div class="row"><div><strong>${escapeHtml(name)}</strong></div><div class="muted">${count} check-ins</div></div>`).join('');
  leaderboardEl.innerHTML = boardHtml||'<div class="empty">No check-ins yet.</div>';
}

setInterval(renderDashboard, REFRESH_MS);
renderDashboard();
</script>
</body>
</html>
